{% extends 'base.html' %}
{% load static %}

{% block title %}Main â€¢ {{ aplikasi }}{% endblock title %}

{% block content %}
{% include 'navbar.html' %}

<section class="section mt-4">
  <div class="mx-auto max-w-7xl px-4">
    <div class="relative overflow-hidden rounded-lg border border-white/10">
      <img src="{% static 'images/imgweb.png' %}" 
           alt="Product showcase banner"
           class="h-[240px] md:h-[360px] w-full object-cover brightness-50" />
      <div class="absolute inset-0 bg-gradient-to-t from-[#0B0D0FCC] to-transparent"></div>
      <div class="absolute inset-0 flex items-start px-6 md:px-10 py-8">
        <div class="rounded-lg p-6 max-w-3xl w-full ml-0 mr-auto">
          <h1 class="font-heading text-3xl md:text-4xl font-extrabold text-white typing welcome"
              data-text="{% if user.is_authenticated %}Halo {{ user.username }}, Welcome to Coach Gear{% else %}Welcome to Coach Gear{% endif %}">
          </h1>
          
          <p class="mt-6 text-gray-200 text-sm md:text-base text-justify typing description"
            data-text="Coach Gear adalah platform e-commerce untuk jual beli barang olahraga dan perlengkapan lifestyle branded, dengan harga terjangkau dan kualitas terjamin. Temukan produk favoritmu mulai dari sepatu, jersey, hingga perlengkapan olahraga lainnya. Semua barang dipilih dengan teliti agar tetap berkualitas, meskipun pre-loved.">
          </p>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="py-6">
  <div class="mx-auto max-w-7xl px-4 flex justify-between items-center">
    <input 
      type="text" 
      id="searchInput" 
      placeholder="Cari produk..." 
      class="bg-black text-white w-full md:w-1/2 px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-yellow-600"
    >
    {% if user.is_authenticated %}
    <button id="addProductBtn" 
      class="ml-4 bg-yellow-600 hover:bg-yellow-700 text-black font-semibold px-5 py-2 rounded-lg transition">
      + Tambah Produk
    </button>
    {% endif %}
  </div>
</section>

<section class="section pt-6">
  <div class="mx-auto max-w-7xl px-4">
    <div id="productContainer">
      {% if not products %}
        <div class="text-center py-12">
          <p class="text-gray-500 text-lg">Belum ada produk yang ditambahkan.</p>
        </div>
      {% else %}
        <div id="productsGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
          {% for product in products %}
            <div class="product-card bg-black rounded-xl overflow-hidden transform transition-transform duration-300 hover:scale-105 hover:shadow-2xl cursor-pointer">
              <img src="{{ product.thumbnail }}" alt="{{ product.name }}" class="h-48 w-full object-cover">
              <div class="p-4 flex flex-col">
                <h2 class="product-name text-lg font-bold text-white">{{ product.name }}</h2>
                <p class="mt-2 font-semibold text-white">Rp {{ product.price }}</p>
                <p class="text-gray-500 text-sm mt-1">Stock: {{ product.stock }}</p>
                <p class="text-gray-300 text-sm mt-2 truncate">{{ product.description|truncatewords:20 }}...</p>
                {% if user.is_authenticated %}
                <div class="flex gap-2 mt-4">
                  <button class="edit-btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg w-full" data-id="{{ product.id }}">Edit</button>
                  <button class="delete-btn bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg w-full" data-id="{{ product.id }}">Hapus</button>
                </div>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>
</section>

<!-- Modal -->
<div id="productModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50">
  <div class="bg-zinc-900 p-6 rounded-2xl w-full max-w-md text-white">
    <h2 id="modalTitle" class="text-2xl font-bold mb-4">Tambah Produk</h2>
    <form id="productForm" class="space-y-4">
      {% csrf_token %}
      <input type="hidden" id="productId">
      <div>
        <label for="name" class="block text-sm font-medium">Nama Produk</label>
        <input type="text" id="name" name="name" class="w-full mt-1 px-3 py-2 bg-zinc-800 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-600" required>
      </div>
      <div>
        <label for="price" class="block text-sm font-medium">Harga</label>
        <input type="number" id="price" name="price" class="w-full mt-1 px-3 py-2 bg-zinc-800 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-600" required>
      </div>
      <div>
        <label for="description" class="block text-sm font-medium">Deskripsi</label>
        <textarea id="description" name="description" class="w-full mt-1 px-3 py-2 bg-zinc-800 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-600" required></textarea>
      </div>
      <div class="flex justify-end gap-3 mt-6">
        <button type="button" id="cancelModal" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">Batal</button>
        <button type="submit" id="saveProductBtn" class="bg-yellow-600 hover:bg-yellow-700 text-black font-semibold px-4 py-2 rounded-lg">Simpan</button>
      </div>
    </form>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function () {
  const modal = $("#productModal");

  // Buka modal Create
  $("#addProductBtn").click(function () {
    $("#modalTitle").text("Tambah Produk");
    $("#productForm")[0].reset();
    $("#productId").val("");
    modal.removeClass("hidden");
  });

  // Tutup modal
  $("#cancelModal").click(() => modal.addClass("hidden"));

  // Submit form Create/Update
  $("#productForm").submit(function (e) {
    e.preventDefault();
    let formData = {
      name: $("#name").val(),
      price: $("#price").val(),
      description: $("#description").val(),
      csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val(),
    };

    let productId = $("#productId").val();
    let url = productId ? `/edit-product/${productId}/` : `/add-product/`;

    $.ajax({
      url: url,
      method: "POST",
      data: formData,
      headers: { "X-Requested-With": "XMLHttpRequest" },
      success: function (response) {
        if (response.status === "success") {
          modal.addClass("hidden");
          loadProducts();
        } else {
          alert("Terjadi kesalahan: " + JSON.stringify(response.errors));
        }
      },
    });
  });

  // Load ulang produk
  function loadProducts() {
    $.ajax({
      url: "/",
      method: "GET",
      headers: { "X-Requested-With": "XMLHttpRequest" },
      success: function (response) {
        let data = JSON.parse(response.products);
        let html = "";
        data.forEach((p) => {
          let f = p.fields;
          html += `
            <div class="product-card bg-black rounded-xl overflow-hidden transform transition-transform duration-300 hover:scale-105 hover:shadow-2xl cursor-pointer">
              <img src="${f.thumbnail || '/static/images/default.png'}" class="h-48 w-full object-cover">
              <div class="p-4 flex flex-col">
                <h2 class="text-lg font-bold text-white">${f.name}</h2>
                <p class="mt-2 font-semibold text-white">Rp ${f.price}</p>
                <p class="text-gray-500 text-sm mt-1">Stock: ${f.stock}</p>
                <p class="text-gray-300 text-sm mt-2 truncate">${f.description}</p>
                <div class="flex gap-2 mt-4">
                  <button class="edit-btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg w-full" data-id="${p.pk}">Edit</button>
                  <button class="delete-btn bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg w-full" data-id="${p.pk}">Hapus</button>
                </div>
              </div>
            </div>
          `;
        });
        $("#productsGrid").html(html);
      },
    });
  }

  // Edit produk
  $(document).on("click", ".edit-btn", function () {
    const id = $(this).data("id");
    $.ajax({
      url: `/product/${id}/`,
      method: "GET",
      headers: { "X-Requested-With": "XMLHttpRequest" },
      success: function (response) {
        const product = JSON.parse(response.product)[0];
        $("#productId").val(product.pk);
        $("#name").val(product.fields.name);
        $("#price").val(product.fields.price);
        $("#description").val(product.fields.description);
        $("#modalTitle").text("Edit Produk");
        modal.removeClass("hidden");
      },
    });
  });

  $(document).on("click", ".delete-btn", function () {
    const id = $(this).data("id");
    if (confirm("Yakin mau hapus produk ini?")) {
      $.ajax({
        url: `/delete-product/${id}/`,
        method: "POST",
        data: { csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val() },
        headers: { "X-Requested-With": "XMLHttpRequest" },
        success: function (response) {
          if (response.status === "success") {
            loadProducts();
          }
        },
      });
    }
  });
});
</script>

<script>
  const searchInput = document.getElementById("searchInput");
  const productCards = document.querySelectorAll(".product-card");

  searchInput.addEventListener("input", function () {
    const query = this.value.toLowerCase();
    productCards.forEach(card => {
      const name = card.querySelector(".product-name").textContent.toLowerCase();
      if (name.includes(query)) {
        card.style.display = "block";
      } else {
        card.style.display = "none";
      }
    });
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
  const welcomeEl = document.querySelector('.typing.welcome');
  const descEl = document.querySelector('.typing.description');

  if (!welcomeEl || !descEl) return;

  const typeTextWithCursor = (el, text, speed = 50) => {
    return new Promise((resolve) => {
      el.textContent = '';
      let i = 0;
      const cursor = '|';
      let showingCursor = true;

      const interval = setInterval(() => {
        if (i <= text.length) {
          el.textContent = text.substring(0, i) + cursor;
          i++;
        } else {
          clearInterval(interval);
          el.textContent = text; 
          resolve();
        }
      }, speed);
    });
  };

  const startTyping = async () => {
    await typeTextWithCursor(welcomeEl, welcomeEl.dataset.text, 50);
    await typeTextWithCursor(descEl, descEl.dataset.text, 30);
  };

  startTyping();
});
</script>

{% endblock content %}
